#!/usr/bin/env php
<?php
/**
 * YFlite CLI Scaffolding Tool
 * Generate routes, pages, CRUD operations, and models
 */

// Find and load the autoloader
$autoloadLocations = [
    __DIR__ . '/../vendor/autoload.php',           // Local package development
    __DIR__ . '/../../../autoload.php',            // Package installed in vendor/
    __DIR__ . '/../../../../vendor/autoload.php',   // Global composer installation
];

$loaded = false;
foreach ($autoloadLocations as $file) {
    if (file_exists($file)) {
        require_once $file;
        $loaded = true;
        break;
    }
}

if (!$loaded) {
    echo "Error: Could not find autoloader. Please run 'composer install' first.\n";
    exit(1);
}

require_once __DIR__ . '/../src/Generators.php';

// Initialize template loader to use package templates
TemplateLoader::setTemplateDir(__DIR__ . '/templates');

$command = $argv[1] ?? null;

if (!$command) {
    echo "YFlite CLI - Scaffolding Tool\n\n";
    echo "Usage: php yflite [command] [options]\n\n";
    echo "Commands:\n";
    echo "  make:page <name> [name2] [name3] ...  Generate page(s)\n";
    echo "  make:crud <ResourceName> [--fields=\"...\"]  Generate full CRUD\n";
    echo "  make:model <ModelName> [--table=table_name]  Generate model\n";
    echo "  make:route <METHOD> <path> <handler>  Add route\n\n";
    echo "Examples:\n";
    echo "  php yflite make:page dashboard\n";
    echo "  php yflite make:page home about contact\n";
    echo "  php yflite make:page settings/profile\n";
    echo "  php yflite make:crud Product\n";
    echo "  php yflite make:crud Product --fields=\"title:string,price:decimal,description:text\"\n";
    echo "  php yflite make:model User --table=users\n";
    echo "  php yflite make:route GET /api/data api:data\n";
    exit(0);
}

switch ($command) {
    case 'make:page':
        // Handle multiple pages: php yflite make:page page1 page2 page3
        $pages = array_slice($argv, 2);
        if (empty($pages)) {
            echo "⚠️  Please provide at least one page name.\n";
            echo "Example: php yflite make:page dashboard\n";
            exit(1);
        }
        makePages($pages);
        break;

    case 'make:crud':
        $name = $argv[2] ?? null;
        $fields = null;

        // Parse --fields option
        for ($i = 3; $i < count($argv); $i++) {
            if (strpos($argv[$i], '--fields=') === 0) {
                $fields = substr($argv[$i], 10); // Remove '--fields='
                $fields = trim($fields, '"\'');
            }
        }

        makeCrud($name, $fields);
        break;

    case 'make:model':
        $name = $argv[2] ?? null;
        $table = null;

        // Parse --table option
        for ($i = 3; $i < count($argv); $i++) {
            if (strpos($argv[$i], '--table=') === 0) {
                $table = substr($argv[$i], 9); // Remove '--table='
            }
        }

        makeModel($name, $table);
        break;

    case 'make:route':
        $method = $argv[2] ?? null;
        $path = $argv[3] ?? null;
        $handler = $argv[4] ?? null;

        if (!$method || !$path || !$handler) {
            echo "⚠️  Usage: php yflite make:route <METHOD> <path> <handler>\n";
            echo "Example: php yflite make:route GET /api/data api:data\n";
            exit(1);
        }

        injectRoute($method, $path, $handler);
        break;

    default:
        echo "❌ Unknown command: $command\n";
        echo "Run 'php yflite' to see available commands.\n";
        exit(1);
}
