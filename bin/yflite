#!/usr/bin/env php
<?php
/** 
 * YFlite CLI Scaffolding Tool
 * Generate routes, pages, CRUD operations, and models
 */

define('YFLITE_VERSION', '1.1.0');
require_once __DIR__ . '/Generators.php';

// Initialize template loader to use package templates
$templateDir = __DIR__ . '/templates';
if (!is_dir($templateDir)) {
    // When installed as dependency, templates are in vendor/chromehive/yflite/bin/templates
    $templateDir = __DIR__ . '/../chromehive/yflite/bin/templates';
}

if (!is_dir($templateDir)) {
    echo "Error: Could not find template directory.\n";
    exit(1);
}

// Initialize template loader to use package templates
TemplateLoader::setTemplateDir(__DIR__ . '/templates');

// Initialize script loader to use package scripts
$scriptDir = __DIR__ . '/scripts';
if (!is_dir($scriptDir)) {
    // When installed as dependency, scripts are in vendor/chromehive/yflite/bin/scripts
    $scriptDir = __DIR__ . '/../chromehive/yflite/bin/scripts';
}

if (!is_dir($scriptDir)) {
    echo "Error: Could not find script directory.\n";
    exit(1);
}

$command = $argv[1] ?? null;

if ($command === '-v' || $command === '--version') {
    echo "YFlite v" . YFLITE_VERSION . "\n";
    exit(0);
}

// Production Build Command
if ($command === 'build') {

    // Allowed flags for YFlite Build
    $allowedArgs = [
        '--dest',
        '--zip',
        '--controllers',
        '--models',
        '--views',
        '--includeFile'
    ];

    // Parse raw arguments AFTER "build"
    $rawArgs = array_slice($argv, 2);

    $finalArgs = [];

    foreach ($rawArgs as $arg) {

        // Match --flag=value  OR  --flag
        if (preg_match('/^(--[a-zA-Z0-9]+)(=(.*))?$/', $arg, $m)) {
            $flag = $m[1];
            $value = $m[3] ?? null;

            // Only accept safe, allowed flags
            if (in_array($flag, $allowedArgs, true)) {

                // If it's a boolean flag like --zip (no =value)
                if ($value === null) {
                    $finalArgs[] = $flag;
                } else {
                    // Clean value (remove weird characters)
                    $value = trim($value, "\"' ");
                    $finalArgs[] = $flag . '=' . escapeshellarg($value);
                }
            }
        }
    }

    // Build final argument string for pack_production.php
    $safeArgString = implode(' ', $finalArgs);

    // Execute production builder safely
    $cmd = "php $scriptDir/pack_production.php $safeArgString";
    $buildResponse = shell_exec($cmd);
    echo $buildResponse;

    exit(0);
}

if (!$command || $command === '-h' || $command === '--help') {
    echo "YFlite CLI - Scaffolding Tool v" . YFLITE_VERSION . "\n\n";
    echo "Usage: yflite [command] [options]\n\n";
    echo "Commands:\n";
    echo "  new                                Creates a new YFlite project in current folder\n";
    echo "  new <app-name>                     Creates project in a newly named folder\n";
    echo "  start                              Start development server (localhost:7777)\n";
    echo "  -v  or  --version                  Display YFlite version\n";
    echo "  -h  or  --help                     Display list of YFlite commands\n";
    echo "  make:page <name1> <name2>          Generate page(s)\n";
    echo "  make:controller <name1> <name2>    Generate controller\n";
    echo "  make:crud <resourceName> [--fields=\"...\"]  Generate full CRUD\n";
    echo "  make:model <ModelName> [--table=table_name]  Generate model\n";
    echo "  make:route <METHOD> <path> <handler>  Add route\n";
    echo "  build --help\n                     Display list of build commands\n";
    echo "  build [--dest=<project-build-name>] [--zip] Get Production Build\n";
    echo "Examples:\n";
    echo "  yflite new fire-app\n";
    echo "  yflite build --dest=v2\n";
    echo "  yflite build --dest=v2 --zip\n";
    echo "  yflite make:page dashboard\n";
    echo "  yflite make:page home about contact\n";
    echo "  yflite make:page settings/profile\n";
    echo "  yflite make:crud blog\n";
    echo "  yflite make:crud blog --fields=\"title:string,price:decimal,description:text\"\n";
    echo "  yflite make:model User --table=users\n";
    echo "  yflite make:route GET /api/data api:data\n";
    exit(0);
}

switch ($command) {
    case 'new':
        $newProjectDir = $argv[2] ?? null;
        // Check if current directory is not empty (excluding hidden files)
        $files = array_filter(scandir('.'), function ($file) {
            return !in_array($file, ['.', '..']) && !str_starts_with($file, '.');
        });

        if (isset($newProjectDir)) {
            // Name of directory given: scaffold project immediately
            echo "Creating new YFlite project...\n";
            createProjectStructure(null, $newProjectDir);
            echo "Project scaffolding complete.\n";
            echo "Run your development server using:.\n";
            echo "cd ./{$newProjectDir}\n";
            echo "composer init\n";
            echo "yflite start \n";
            exit(1);
        }

        if (empty($files)) {
            // Empty directory: use fast, non-interactive creation
            echo "Creating new YFlite project...\n";
            createProjectStructure();
            echo "Project scaffolding complete.\n";
        } else {
            // Non-empty directory: use safe mode with user prompts
            echo "Warning: Current directory is not empty.\n";
            echo "Wish to continue in this current directory and selectively create project files? [y/N]: ";
            $answer = strtolower(trim(fgets(STDIN) ?: ''));
            if ($answer !== 'y') {
                // Ask if user wants to create a new project directory
                echo "Do you want to create a new directory for this project? [y/N]: ";
                $answer2 = strtolower(trim(fgets(STDIN) ?: ''));
                if ($answer2 !== 'y') {
                    echo "Aborted: let's make an awesome project later then.\n";
                    exit(1);
                } else {
                    echo "Name your new project: ";
                    $answer3 = strtolower(trim(fgets(STDIN) ?: ''));
                    if (!empty($answer3)) {
                        echo "Great choice!\n";
                        // Make new named directory and begin scaffolding
                        echo "Creating new YFlite project... ./$answer3 \n";
                        createProjectStructure(null, $answer3);
                        echo "Project scaffolding complete.\n";
                        echo "Run your development server using:\n";
                        echo "cd ./{$answer3}\n";
                        echo "composer init\n";
                        echo "yflite start\n";
                        exit(0);
                    }
                }
            }

            echo "Creating new YFlite project (safe mode)...\n";
            createProjectStructureSafe($templateDir, null);
            echo "Project scaffolding complete.\n";
        }

        echo "Run your development server using:\n";
        echo "composer init\n";
        echo "yflite start\n";
        exit(0);

    case 'start':
        $port = 7777;
        if (file_exists($projectRoot . "/public/index.php")) {
            echo "Starting development server on http://localhost:{$port}\n";
            echo "Press Ctrl+C to stop\n";
            shell_exec("php -S localhost:{$port} -t public");
        } else {
            echo "Entry file not found. Failed to start development server.\n";
        }
        exit(0);

    case 'make:page':
        // Handle multiple pages: yflite make:page page1 page2 page3
        $pages = array_slice($argv, 2);
        if (empty($pages)) {
            echo "⚠️  Please provide at least one page name.\n";
            echo "Example: yflite make:page dashboard\n";
            exit(1);
        }
        makePages($pages);
        break;

    case 'make:controller':
        // Handle multiple controllers: yflite make:controller controller1 controller2 controller3
        $controllers = array_slice($argv, 2);
        if (empty($controllers)) {
            echo "Error: Controller name is required\n";
            echo "Usage: yflite make:controller controllerName\n";
            exit(1);
        }
        makeControllers($controllers);
        break;

    case 'make:crud':
        $name = $argv[2] ?? null;
        $fields = null;

        // Parse --fields option
        for ($i = 3; $i < count($argv); $i++) {
            if (strpos($argv[$i], '--fields=') === 0) {
                $fields = substr($argv[$i], 10); // Remove '--fields='
                $fields = trim($fields, '"\'');
            }
        }

        makeCrud($name, $fields);
        break;

    case 'make:model':
        $name = $argv[2] ?? null;
        $table = null;

        // Parse --table option
        for ($i = 3; $i < count($argv); $i++) {
            if (strpos($argv[$i], '--table=') === 0) {
                $table = substr($argv[$i], 9); // Remove '--table='
            }
        }

        makeModel($name, $table);
        break;

    case 'make:route':
        $method = $argv[2] ?? null;
        $path = $argv[3] ?? null;
        $handler = $argv[4] ?? null;

        if (!$method || !$path || !$handler) {
            echo "⚠️  Usage: yflite make:route <METHOD> <path> <handler>\n";
            echo "Example: yflite make:route GET /api/data api:data\n";
            exit(1);
        }

        injectRoute($method, $path, $handler);
        break;

    default:
        echo "❌ Unknown command: $command\n";
        echo "Run 'yflite -h' to see available commands.\n";
        exit(1);
}

