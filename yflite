#!/usr/bin/env php
<?php
/**
 * YFlite CLI Scaffolding Tool
 * Generate routes, pages, CRUD operations, and models
 */

define('YFLITE_VERSION', '0.1.0');
require_once __DIR__ . '/Generators.php'; //../src/

// Initialize template loader to use package templates
$templateDir = __DIR__ . '/templates';
if (!is_dir($templateDir)) {
    // When installed as dependency, templates are in vendor/chromehive/yflite/bin/templates
    $templateDir = __DIR__ . '/../chromehive/yflite/bin/templates';
}

if (!is_dir($templateDir)) {
    echo "Error: Could not find template directory.\n";
    exit(1);
}

// Initialize template loader to use package templates
TemplateLoader::setTemplateDir(__DIR__ . '/templates');

$command = $argv[1] ?? null;

if ($command === '-v' || $command === '--version') {
    echo "YFlite v" . YFLITE_VERSION . "\n";
    exit(0);
}

if (!$command) {
    echo "YFlite CLI - Scaffolding Tool v" . YFLITE_VERSION . "\n\n";
    echo "Usage: yflite [command] [options]\n\n";
    echo "Commands:\n";
    echo "  new                                Create a new YFlite project\n";
    echo "  start                              Start development server (localhost:7777)\n";
    echo "  -v  or  --version                  Display YFlite version\n";
    echo "  make:page <n> [name2] [name3] ...  Generate page(s)\n";
    echo "  make:controller <name>             Generate controller\n";
    echo "  make:crud <ResourceName> [--fields=\"...\"]  Generate full CRUD\n";
    echo "  make:model <ModelName> [--table=table_name]  Generate model\n";
    echo "  make:route <METHOD> <path> <handler>  Add route\n\n";
    echo "Examples:\n";
    echo "  yflite make:page dashboard\n";
    echo "  yflite make:page home about contact\n";
    echo "  yflite make:page settings/profile\n";
    echo "  yflite make:crud blog\n";
    echo "  yflite make:crud blog --fields=\"title:string,price:decimal,description:text\"\n";
    echo "  yflite make:model User --table=users\n";
    echo "  yflite make:route GET /api/data api:data\n";
    exit(0);
}

switch ($command) {
    case 'new':
        // Check if current directory is not empty (excluding hidden files)
        $files = array_filter(scandir('.'), function ($file) {
            return !in_array($file, ['.', '..']) && !str_starts_with($file, '.');
        });

        if (!empty($files)) {
            echo "Error: Cannot initialize new project in a non-empty directory.\n";
            echo "Please create a new empty directory and run 'yflite new' there.\n";
            exit(1);
        }

        echo "Creating new YFlite project...\n";
        // Create project structure
        createProjectStructure();
        echo "Project created successfully!\n";
        echo "Run 'yflite start' to launch the development server.\n";
        exit(0);

    case 'start':
        $port = 7777;
        echo "Starting development server on http://localhost:{$port}\n";
        echo "Press Ctrl+C to stop\n";
        shell_exec("php -S localhost:{$port} -t public");
        exit(0);

    case 'make:page':
        // Handle multiple pages: yflite make:page page1 page2 page3
        $pages = array_slice($argv, 2);
        if (empty($pages)) {
            echo "⚠️  Please provide at least one page name.\n";
            echo "Example: yflite make:page dashboard\n";
            exit(1);
        }
        makePages($pages);
        break;

    case 'make:controller':
        // Handle multiple controllers: yflite make:controller controller1 controller2 controller3
        $controllers = array_slice($argv, 2);
        if (empty($controllers)) {
            echo "Error: Controller name is required\n";
            echo "Usage: yflite make:controller controllerName\n";
            exit(1);
        }
        makeControllers($controllers);
        break;

    case 'make:crud':
        $name = $argv[2] ?? null;
        $fields = null;

        // Parse --fields option
        for ($i = 3; $i < count($argv); $i++) {
            if (strpos($argv[$i], '--fields=') === 0) {
                $fields = substr($argv[$i], 10); // Remove '--fields='
                $fields = trim($fields, '"\'');
            }
        }

        makeCrud($name, $fields);
        break;

    case 'make:model':
        $name = $argv[2] ?? null;
        $table = null;

        // Parse --table option
        for ($i = 3; $i < count($argv); $i++) {
            if (strpos($argv[$i], '--table=') === 0) {
                $table = substr($argv[$i], 9); // Remove '--table='
            }
        }

        makeModel($name, $table);
        break;

    case 'make:route':
        $method = $argv[2] ?? null;
        $path = $argv[3] ?? null;
        $handler = $argv[4] ?? null;

        if (!$method || !$path || !$handler) {
            echo "⚠️  Usage: yflite make:route <METHOD> <path> <handler>\n";
            echo "Example: yflite make:route GET /api/data api:data\n";
            exit(1);
        }

        injectRoute($method, $path, $handler);
        break;

    default:
        echo "❌ Unknown command: $command\n";
        echo "Run 'yflite' to see available commands.\n";
        exit(1);
}
